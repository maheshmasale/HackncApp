<html>
<head>
  <title>Express HTML</title>
 
  <script data-main="/lib/capital_one.js" src="/lib/require-jquery.js"></script>

  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
   <!-- Load the Leaflet from CDN. More info at: http://leafletjs.com/examples/quick-start.html-->
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
   <!-- Load jQuery from CDN. jQuery is used to put the GeoJSON points on the map-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
   <!-- Load the Esri Leaflet plugin from CDN.  For more info: http://esri.github.io/esri-leaflet/examples/ -->
  <script src="//cdn.jsdelivr.net/leaflet.esri/1.0.0/esri-leaflet.js"></script>



  <script type="text/javascript">

    $(document).ready(function() {

    require(['atm'], function (atm_inp) {
          atm = atm_inp

      });
      $('#fetchData').click(function() {
        var data = atmDemo()
//Create bike icon to style points
var dollarIcon = L.icon({
//Replace URL on the next line to point to your icon
iconUrl : 'https://cdn0.iconfinder.com/data/icons/shift-free/32/Currency_dollar-16.png',
iconSize : [8, 16]
});
// add GeoJSON layer to the map once the file is loaded
L.geoJson(data, {
pointToLayer : function (feature, latlng) {
//Create Bike Icon Marker
var marker = L.marker(latlng, {
icon : dollarIcon
});
//To show the fields in your data, replace the field names in the {} to match your data
marker.bindPopup("Name :" + feature.properties.name + '<br/>' + "Hours : " + feature.properties.hours + '<br/>' + "Address : " + feature.properties.address);
return marker;
}
//add data layer containing bike crash data to the map
}).addTo(map);
      });
    });
    
    
    function atmDemo() {
      console.log('Atm Demo');
      //var bankAtms = atm.initWithKey("4495856d0c2b6947ae81b8ab48802308");

      Config = require('capital_one');
      var atmslist = [];
      var continueFetching = true;
      var nextPage = "/atms?key=4495856d0c2b6947ae81b8ab48802308"

      while(continueFetching)
      {
        var request = $.ajax({ url: Config.baseUrl+nextPage, 
        //data: 'key='+"4495856d0c2b6947ae81b8ab48802308", 
        async: false,
        dataType: 'json'});

        request.complete(function(results) {
          if(results.responseJSON.data.length < 2)
          {
              continueFetching = false;
          }
          nextPage = results.responseJSON.paging.next;
          for(i =0; i < results.responseJSON.data.length; i++){
           var tempData = results.responseJSON.data[i];

           atmslist.push({
             "geometry":{
               "type":"Point",
               "coordinates":[
                 tempData.geocode.lat,
                 tempData.geocode.lng
               ]
             },
             "properties":{
               "id": tempData._id,
               "amount_left" : tempData.amount_left,
               "name": tempData.name,
               "hours" : tempData.hours[0],
               "address": tempData.address.street_number + " "+ tempData.address.street_name + ", " + tempData.address.city + ", " + tempData.address.state
             }
           });
         }

        });
        
      }
     
      return atmslist;
    }
    function function_name(argument) {
        // body...
      }  

  </script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
</head>
<body>
  <div style="margin:100px;">
    <nav class="navbar navbar-inverse navbar-static-top">
  <div class="container">
    <a class="navbar-brand" href="/">Express HTML</a>
    <ul class="nav navbar-nav">
      <li class="active">
        <a href="/">Home</a>
      </li>
      <li>
        <a href="/about">About</a>
      </li>
      <li>
        <a href="/sitemap">Sitemap</a>
      </li>
    </ul>
  </div>
</nav>
    <div class="jumbotron"  style="padding:40px;">
      <button id="fetchData" class="btn btn-primary btn-lg" >Fetch</button>
      <div id ="map" height:200px width:500px></div> 
    </div>
  </div>
</body>
</html>